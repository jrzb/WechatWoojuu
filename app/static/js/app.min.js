/*! wechat.woojuu.cc 2013-05-18 */
(function(){"use strict";var t,e;t=angular.module("wwApp",["wwAppDep"]),e=angular.module("wwAppDep",["ngResource"]),e.config(["$routeProvider","$locationProvider",function(t,e){return t.when("/",{templateUrl:"/static/partials/no.html"}),t.when("/u/:userId",{templateUrl:"/static/partials/dashboard.html",controller:"DashboardCtrl"}),t.when("/u/:userId/details",{templateUrl:"/static/partials/details.html",controller:"DetailsCtrl"}),t.otherwise({redirectTo:"/"}),e.html5Mode(!0)}]),e.controller("MainCtrl",["$scope","$location",function(t,e){var n;return n=e.path().split("/"),t.userId=n[2]}]),e.controller("DashboardCtrl",["$scope","$http","$routeParams","$filter","DashboardAPI","SharedProperties",function(t,e,n,r,i,s){var a,o,u,h,c,d,l;return l=n.userId,u=Date.today().getWeek()-1,c=s.getWeek(u),h={userid:l,categories:"",fromdate:c.firstWeekDay,enddate:c.lastWeekDay},i.summary(h,function(e){return t.summary=e[0]}),d={userid:n.userId,fromdate:c.firstWeekDay,enddate:c.lastWeekDay,limit:1},i.category(d,function(e){return t.top=e[0]}),o=s.getWeek(0),a={userid:l,fromdate:o.firstWeekDay,enddate:o.lastWeekDay},i.chart(a,function(e){var n,r,i;return i=function(){var t,n,i;for(i=[],t=0,n=e.length;n>t;t++)r=e[t],i.push(parseInt(r.totalamount));return i}(),Highcharts.setOptions({colors:["rgb(65,105,42)","rgb(29,78,0)","rgb(225,231,217)","rgb(65,105,42)","rgb(29,78,0)","rgb(225,231,217)","rgb(65,105,42)","rgb(29,78,0)","rgb(225,231,217)","rgb(225,231,217)"]}),n={chart:{backgroundColor:null},credits:{enabled:!1},subtitle:{text:null},legend:{enabled:!1},exporting:{enabled:!1},tooltip:{backgroundColor:"rgba(225,231,217,0.65)",borderWidth:0,shadow:!1},xAxis:{categories:["周一","二","三","四","五","六","日"],lineWidth:0,tickColor:Highcharts.getOptions().colors[2],labels:{y:25,useHTML:!0,style:{color:Highcharts.getOptions().colors[1]},formatter:function(){return"Hey "+this.value}}},yAxis:{showEmpty:!1,gridLineWidth:1,gridLineColor:"rgb(225,231,217)",labels:{style:{color:Highcharts.getOptions().colors[1]}},title:{text:null}},plotOptions:{areaspline:{lineWidth:3,marker:{fillColor:"rgb(225,231,217)",lineColor:"rgb(65,105,42)",lineWidth:4,radius:6}}},series:[{name:"今日",data:i,fillColor:{linearGradient:[0,0,0,270],stops:[[0,"rgba(29,78,0,0.6)"],[1,"rgba(29,78,0,0.05)"]]}}]},t.weeklyChart=n,t.weeklyTotal=i.reduce(function(t,e){return t+e})})}]),e.controller("DetailsCtrl",["$scope","$http","$routeParams","DetailsAPI","SharedProperties",function(t,e,n,r,i){var s,a,o;return s=function(e){var i;return i={userid:n.userId,fromdate:e.firstWeekDay,enddate:e.lastWeekDay},r.list(i,function(e){var n,r,i,s,a,o,u,h;for(r={},a=e,u=0,h=a.length;h>u;u++)s=a[u],n=Date.parse(s.date).toString("yyyy-MM-dd"),delete s.date,r[n]?r[n].push(s):r[n]=[s];return t.expenses=function(){var t;t=[];for(i in r)o=r[i],t.push({date:i,expenses:o});return t}(),console.log(t.expenses)})},o=0,a=i.getWeek(o),s(a),t.removeExpense=function(e,i,s){var a,o;return o=window.confirm("确认删除？"),o?(a={userid:n.userId,expenseid:e},r.remove(a,function(e){var n;return"200"===e.errorcode&&(n=t.expenses[i].expenses,n.splice(s,1),0===n.length)?t.expenses.splice(i,1):void 0})):void 0},t.loadPrevWeek=function(){return o+=1,a=i.getWeek(o),s(a)}}]),e.directive("chart",function(){return{restrict:"E",template:"<div></div>",transclude:!0,replace:!0,link:function(t,e,n){var r;return r={chart:{renderTo:e[0],type:n.type||null,height:n.height||null,width:n.width||null},title:{text:n.title||null}},t.$watch(function(){return n.value},function(){var t,e,i;return n.value?(e=!0,i={},$.extend(e,i,r,JSON.parse(n.value)),t=new Highcharts.Chart(i)):!0})}}}),e.filter("currency",function(){return function(t,e,n,r,i,s){return null==e&&(e="$"),null==n&&(n=2),null==r&&(r=","),null==i&&(i="."),null==s&&(s="%s%f"),accounting.formatMoney(t,e,n,r,i,s)}}),e.filter("dateformat",function(){return function(t,e){return null==e&&(e="yyyy-MM-dd"),Date.parse(t).toString(e)}}),e.filter("isnotes",function(){return function(t){var e;return""!==t?e=t:""===t?e="未知消费":void 0}}),e.service("SharedProperties",["$filter",function(t){return this.getWeek=function(e){var n,r,i,s;return null==e&&(e=0),n=-(7*e),r=Date.today().is().sunday()?Date.previous().monday().addDays(n):Date.monday().addDays(n),i=Date.next().monday().addSeconds(-1),s={firstWeekDay:t("date")(r,"yyyy-MM-dd HH:mm:ss"),lastWeekDay:t("date")(i,"yyyy-MM-dd HH:mm:ss")}}}]),e.factory("DashboardAPI",["$resource",function(t){return t("http://h.woojuu.cc/:api",{api:"summary"},{summary:{method:"GET",params:{userid:"@userid",categories:"@categories",fromdate:"@fromdate",enddate:"@enddate"},isArray:!0},category:{method:"GET",params:{api:"topn_category",userid:"@userid",fromdate:"@fromdate",enddate:"@enddate",limit:"@limit"},isArray:!0},chart:{method:"GET",params:{api:"summary_daily",userid:"@userid",fromdate:"@fromdate",enddate:"@enddate"},isArray:!0}})}]),e.factory("DetailsAPI",["$resource",function(t){return t("http://h.woojuu.cc/:api",{api:"list_expense"},{list:{method:"GET",params:{userid:"@userid",fromdate:"@fromdate",enddate:"@enddate"},isArray:!0},remove:{method:"POST",params:{api:"delete_expense",userid:"@userid",expenseid:"@expenseid"}}})}])}).call(this);